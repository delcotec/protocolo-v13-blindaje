<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo V13 - Confianza Inmutable T-01 (AME)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // [SELLO DEL CREADOR] MANIFIESTO_V13: FUSI√ìN DE BLINDAJE (T-01) Y MONETIZACI√ìN (AME).
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background-void': '#070D13',
                        'panel-deep': '#121921',
                        'accent-cobalt': '#005691',
                        'text-highlight': '#C0D6E4',
                        'text-standard': '#E0E6EB',
                        'alert-warning': '#C27B2B',
                        'alert-error-bg': 'rgba(194, 123, 43, 0.1)',
                        'urgency-red': '#E74C3C', // NODO ALTO: Color para la Urgencia Fantasma
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-void);
            color: var(--text-standard);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
        }
        .terminal-container {
            width: 100%;
            max-width: 600px;
            background-color: var(--panel-deep);
            border: 1px solid var(--accent-cobalt);
            border-radius: 8px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.8);
        }
        /* [OMNIPRESENCIA VISUAL] */
        .status-box { border-left: 4px solid; padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 4px; font-weight: 600; }
        .status-ready { border-color: #005691; background-color: rgba(0, 86, 145, 0.1); color: #C0D6E4; }
        .status-loading { border-color: #6A798A; background-color: rgba(106, 121, 138, 0.1); color: #E0E6EB; }
        .status-error { border-color: var(--alert-warning); background-color: var(--alert-error-bg); color: var(--alert-warning); }
        .status-success { border-color: #1E8449; background-color: rgba(30, 132, 73, 0.1); color: #90EE90; }

        #activate-button {
            background-color: #005691;
            color: white;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 8px rgba(0, 86, 145, 0.5);
            border: 1px solid #00406F;
        }
        #activate-button:hover:not(:disabled) {
            background-color: #0070B8;
            box-shadow: 0 4px 12px rgba(0, 86, 145, 0.7);
            transform: translateY(-1px);
        }
    </style>
</head>
<body onload="iniciar_contador_ame()">

    <div id="app" class="terminal-container p-8 md:p-10">
        <h1 class="text-4xl font-extrabold mb-4 text-text-highlight text-center uppercase tracking-widest border-b border-accent-cobalt/50 pb-3">
            PROTOCOLO V13: CONFIANZA INMUTABLE
        </h1>
        <p class="text-md font-light text-center mb-8 text-gray-400">
            M√≥dulo de Cumplimiento Normativo y Verificaci√≥n de V√≠nculo (T-01)
        </p>
        
        <div id="urgency-bar" class="status-box" style="border-color: var(--urgency-red); background-color: rgba(231, 76, 60, 0.1);">
            <p class="font-extrabold text-xl text-center" style="color: var(--urgency-red);">
                OFERTA REL√ÅMPAGO FANTASMA CIERRA EN: <span id="contador-ame" class="font-black text-2xl">--:--:--</span>
            </p>
        </div>
        <div id="system-status" class="status-box status-loading">
            <p class="font-extrabold text-xl text-text-standard">Estado del Enlace Fiduciario:</p>
            <p id="auth-status-text" class="text-sm">Iniciando protocolo de validaci√≥n de credenciales en entorno seguro...</p>
        </div>

        <div id="user-info" class="mb-6 hidden">
            <p class="text-xs text-gray-500 mb-2 font-medium">IDENTIFICADOR SYNC-POINT √öNICO (Para Auditor√≠a):</p>
            <code id="user-id-display" class="bg-[#070D13] text-text-highlight p-2 rounded text-sm break-all font-mono border border-accent-cobalt/30"></code>
        </div>

        <div id="blindaje-form-area" class="mt-8">
            <h2 class="text-2xl text-accent-cobalt font-bold mb-5 border-b border-text-highlight/30 pb-3">REGISTRO T-01: Certificaci√≥n de Transparencia del Origen</h2>

            <div class="mb-6">
                <label for="crypto-address" class="block text-lg font-medium mb-2 text-text-standard">
                    Direcci√≥n P√∫blica (V√≠nculo Certificado - **SOLO ETHEREUM**)
                </label>
                <input type="text" id="crypto-address" placeholder="Ej: 0x22Bf...D5c3"
                        class="w-full px-4 py-3 bg-[#070D13] border border-accent-cobalt/60 rounded-lg focus:ring-accent-cobalt focus:border-accent-cobalt text-text-standard placeholder-gray-600 transition-colors duration-200 text-base">
            </div>

            <button id="activate-button" onclick="handleBlindajeT01()"
                    class="w-full font-extrabold text-lg py-3 rounded-lg uppercase tracking-wider disabled:opacity-30 disabled:cursor-not-allowed"
                    disabled>
                ACTIVAR BLINDAJE T-01 Y CERTIFICAR CUMPLIMIENTO
            </button>
        </div>

        <div id="message-container" class="mt-8 p-4 rounded-lg hidden">
            <p id="message-text" class="text-base"></p>
        </div>
    </div>

    <script type="module">
        // Importaciones de Firebase (necesarias para la estructura de su c√≥digo)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================================
        // !!! ATENCI√ìN CR√çTICA V13: CONFIGURACI√ìN DE INFRAESTRUCTURA
        // ** DEBE REEMPLAZAR estos valores con sus credenciales REALES para activar la Derivada 3. **
        // =========================================================================================
        const FIREBASE_CONFIG = {
            apiKey: "PEGA_AQUI_TU_API_KEY", // CR√çTICO
            authDomain: "PEGA_AQUI_TU_AUTH_DOMAIN",
            projectId: "PEGA_AQUI_TU_PROJECT_ID", // CR√çTICO
            storageBucket: "PEGA_AQUI_TU_STORAGE_BUCKET",
            messagingSenderId: "PEGA_AQUI_TU_MESSAGING_SENDER_ID",
            appId: "PEGA_AQUI_TU_APP_ID"
        };
        const APP_ID = FIREBASE_CONFIG.projectId || 'default-app-id';

        // Constantes del NODO ALTO (Derivada 1: Monetizaci√≥n)
        const URL_CHECKOUT_FINAL = "https://TU_CHECKOUT_REAL.com/pago_v13"; // <--- REEMPLAZAR CON SU GATEWAY DE PAGO
        const CIERRE_OFERTA_AME = '2025-11-01T14:30:00Z'; // 09:30 AM EST (48 Horas desde el momento de la ejecuci√≥n)

        // Referencias del DOM y variables de estado (mantener)
        const authStatusText = document.getElementById('auth-status-text');
        const systemStatusBox = document.getElementById('system-status');
        const activateButton = document.getElementById('activate-button');
        const cryptoAddressInput = document.getElementById('crypto-address');
        const userIdDisplay = document.getElementById('user-id-display');
        const userInfoDiv = document.getElementById('user-info');
        const messageContainer = document.getElementById('message-container');
        const messageText = document.getElementById('message-text');

        let db;
        let auth;
        let userId = 'N/A';
        let isAuthReady = false;

        // Funci√≥n de utilidad (mantener)
        function displayMessage(text, type = 'status-success') {
            messageContainer.classList.remove('hidden', 'status-ready', 'status-loading', 'status-error', 'status-success');
            messageContainer.className = `mt-8 p-4 rounded-lg status-box ${type}`;
            messageText.textContent = text;
        }
        
        // =========================================================================================
        // ‚öîÔ∏è BLINDAJE ESTRAT√âGICO: Validaci√≥n de Formato ETH (Derivada 2)
        // =========================================================================================
        function es_direccion_eth(direccion) {
            // Regex estricta para direcciones Ethereum (0x seguido de 40 caracteres hexadecimales)
            // Esto elimina la fricci√≥n de leads de bajo valor.
            const eth_regex = /^(0x)?[0-9a-fA-F]{40}$/;
            return eth_regex.test(direccion);
        }

        // --- Configuraci√≥n e Inicializaci√≥n de Firebase (con Blindaje de Fallo) ---
        try {
            if (FIREBASE_CONFIG.apiKey.includes('PEGA_AQUI_TU_API_KEY')) {
                // ANULACI√ìN DE SIMULACI√ìN: FUERZA EL REGISTRO DEGENERADO (ZRD)
                systemStatusBox.className = 'status-box status-error';
                authStatusText.textContent = 'ERROR [I-00]: Fallo de Inicializaci√≥n. PROTOCOLO ZRD (Riesgo Cero) ACTIVO. Venta en Modo Local.';
                activateButton.disabled = false; // Se habilita para la venta local (no hay fricci√≥n de conexi√≥n)
                isAuthReady = false; // Firebase no est√° listo
                displayMessage(`WARNING V13: Credenciales de Nube Ausentes. Ejecutando en Modo BLINDAJE LOCAL. La venta contin√∫a.`, 'status-error');
            } else {
                // Ejecuci√≥n Normal (si las credenciales son reales)
                setLogLevel('debug');
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        userInfoDiv.classList.remove('hidden');
                        systemStatusBox.className = 'status-box status-ready';
                        authStatusText.textContent = 'Enlace Fiduciario: ONLINE. SYNC-POINT Autenticado. Protocolo Operativo.';
                        activateButton.disabled = false;
                        isAuthReady = true;
                    } else {
                        // Intento de autenticaci√≥n an√≥nima si no hay usuario
                        await signInAnonymously(auth);
                    }
                });
            }

        } catch (error) {
            // Fallo Inesperado de Inicializaci√≥n
            console.error("Error al inicializar Firebase:", error);
            systemStatusBox.className = 'status-box status-error';
            authStatusText.textContent = `ERROR [I-00]: Fallo Cr√≠tico de Nube. Usando Registro Degenerado.`;
            activateButton.disabled = false; // Forzar la activaci√≥n para la venta (NO-FALLO)
            isAuthReady = false;
            displayMessage(`ERROR CR√çTICO: Fallo en Nube. Venta Incondicional en Modo Local.`, 'status-error');
        }


        // =========================================================================================
        // üöÄ FUNCI√ìN CENTRAL: BLINDAJE Y DISPARO DE PAGO (Derivadas 1 y 2)
        // =========================================================================================
        window.handleBlindajeT01 = async () => {
            const address = cryptoAddressInput.value.trim();

            if (!es_direccion_eth(address)) {
                // FALLO DE BLINDAJE: Rechazo de leads de baja calidad.
                displayMessage("ADVERTENCIA [E-02]: Direcci√≥n no Certificada. **SOLO** se acepta formato Ethereum para el Blindaje T-01 (0x...).", 'status-error');
                return;
            }
            
            activateButton.disabled = true;
            activateButton.textContent = 'EJECUTANDO PROTOCOLO (VALIDACI√ìN DE CUMPLIMIENTO)...';
            displayMessage("Blindaje T-01 en curso. Registrando Petici√≥n en el Ledger de Cumplimiento...", 'status-loading');

            let registroExitoso = false;

            // 1. INTENTO DE REGISTRO EN LA NUBE (Derivada 3: Escalado - NODO ALTO)
            if (isAuthReady && db) {
                try {
                    const collectionPath = `artifacts/${APP_ID}/public/data/blindaje_t01_requests`;
                    const blindajeCollection = collection(db, collectionPath);

                    const blindajeData = {
                        syncPointId: userId,
                        blindajeAddress: address,
                        timestamp: serverTimestamp(),
                        protocolVersion: 'V13.0.5 (AME)',
                        status: 'T-01_CERTIFICACION_EN_PROGRESO',
                        userAgent: navigator.userAgent
                    };

                    const docRef = await addDoc(blindajeCollection, blindajeData);
                    console.log(`Blindaje T-01 registrado en Nube. Document ID: ${docRef.id}`);
                    registroExitoso = true;
                } catch (e) {
                    // Fallo en la nube, pero no es Falla Cr√≠tica (La Venta es primero)
                    console.error("Fallo Parcial: Error al registrar en Nube. Usando Registro Degenerado.", e);
                }
            } else {
                 // REGISTRO DEGENERADO (ZRD): Se registra en la consola para el backend de rastreo.
                 console.log(`[REGISTRO ZRD ACTIVO]: Lead Capturado (No-Nube). Direcci√≥n: ${address}, ID: ${userId}, Time: ${new Date().toISOString()}`);
                 registroExitoso = true; // El lead fue capturado localmente
            }

            // 2. DISPARO DE PAGO INMEDIATO (Derivada 1: Monetizaci√≥n Incondicional)
            if (registroExitoso) {
                displayMessage(
                    `CERTIFICACI√ìN T-01 CONCLUIDA. ID DE V√çNCULO: ${userId}. INICIANDO M√ìDULO DE PAGO INEVITABLE ($1,777 USD).`,
                    'status-success'
                );
                cryptoAddressInput.disabled = true;

                // **ACCI√ìN CR√çTICA: REDIRECCI√ìN AL CHECKOUT**
                const URL_FINAL = `${URL_CHECKOUT_FINAL}?address=${address}&sync_id=${userId}`;
                
                // Muestra un diagrama del Flujo de Venta Incondicional V13
                
                
                console.log(`‚úÖ REDIRECCIONANDO AL CHECKOUT: ${URL_FINAL}`);
                // window.location.href = URL_FINAL; // <--- Descomentar para producci√≥n.
            } else {
                 displayMessage(`FALLO CR√çTICO [T-01]: La Venta no puede ser completada. Revise su conexi√≥n de red.`, 'status-error');
            }
            
            activateButton.textContent = 'ACTIVAR BLINDAJE T-01 Y CERTIFICAR CUMPLIMIENTO';
            if (!registroExitoso) activateButton.disabled = false; // Reintentar si fall√≥ totalmente.
        };


        // =========================================================================================
        // ‚è≥ NODO ALTO DE URGENCIA FANTASMA
        // =========================================================================================
        window.iniciar_contador_ame = () => {
            const fecha_cierre = new Date(CIERRE_OFERTA_AME).getTime();
            const contador_dom = document.getElementById("contador-ame");
            const button_dom = document.getElementById("activate-button");

            const x = setInterval(function() {
                const ahora = new Date().getTime();
                const distancia = fecha_cierre - ahora;

                if (distancia < 0) {
                    clearInterval(x);
                    contador_dom.innerHTML = "OFERTA CERRADA - MULTIPLICADOR INACTIVO";
                    button_dom.disabled = true;
                    return;
                }

                const h = Math.floor((distancia % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((distancia % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((distancia % (1000 * 60)) / 1000);

                contador_dom.innerHTML = `${h < 10 ? "0" + h : h}:${m < 10 ? "0" + m : m}:${s < 10 ? "0" + s : s}`;
            }, 1000);
        }

        window.handleBlindajeT01 = handleBlindajeT01;
    </script>
</body>
</html>








