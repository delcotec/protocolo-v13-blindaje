<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo V13 - Confianza Inmutable T-01</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de color: Máxima Seriedad y Confianza Inmutable -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background-void': '#070D13', // Base: Negro Carbón Total (Máximo Control)
                        'panel-deep': '#121921', // Panel: Gris Pizarra Profundo
                        'accent-cobalt': '#005691', // Azul Cobalto Profundo (Confianza, Legalidad)
                        'text-highlight': '#C0D6E4', // Gris Frío Claro (Énfasis Serio)
                        'text-standard': '#E0E6EB', // Texto Base
                        'alert-warning': '#C27B2B', // Naranja Quemado Profundo (Advertencia/Atención)
                        'alert-error-bg': 'rgba(194, 123, 43, 0.1)', // Fondo de error sutil
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-void);
            color: var(--text-standard);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
        }
        .terminal-container {
            width: 100%;
            max-width: 600px;
            background-color: var(--panel-deep);
            border: 1px solid var(--accent-cobalt);
            border-radius: 8px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.8);
        }
        .status-box {
            border-left: 4px solid;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            font-weight: 600;
        }
        /* Colores de estado: Evitando el rojo de peligro */
        .status-ready { border-color: #005691; background-color: rgba(0, 86, 145, 0.1); color: #C0D6E4; }
        .status-loading { border-color: #6A798A; background-color: rgba(106, 121, 138, 0.1); color: #E0E6EB; } /* Gris más frío para cargando */
        .status-error { border-color: var(--alert-warning); background-color: var(--alert-error-bg); color: var(--alert-warning); } /* Naranja quemado para error */
        .status-success { border-color: #1E8449; background-color: rgba(30, 132, 73, 0.1); color: #90EE90; } 

        /* Estilo del botón de activación: Máxima Fiabilidad */
        #activate-button {
            background-color: #005691;
            color: white;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 8px rgba(0, 86, 145, 0.5);
            border: 1px solid #00406F;
        }
        #activate-button:hover:not(:disabled) {
            background-color: #0070B8;
            box-shadow: 0 4px 12px rgba(0, 86, 145, 0.7);
            transform: translateY(-1px);
        }
    </style>
</head>
<body>

    <div id="app" class="terminal-container p-8 md:p-10">
        <h1 class="text-4xl font-extrabold mb-4 text-text-highlight text-center uppercase tracking-widest border-b border-accent-cobalt/50 pb-3">
            PROTOCOLO V13: CONFIANZA INMUTABLE
        </h1>
        <p class="text-md font-light text-center mb-8 text-gray-400">
            Módulo de Cumplimiento Normativo y Verificación de Vínculo (T-01)
        </p>

        <!-- AREA DE ESTADO DEL SISTEMA -->
        <div id="system-status" class="status-box status-loading">
            <p class="font-extrabold text-xl text-text-standard">Estado del Enlace Fiduciario:</p>
            <p id="auth-status-text" class="text-sm">Iniciando protocolo de validación de credenciales en entorno seguro...</p>
        </div>

        <div id="user-info" class="mb-6 hidden">
            <p class="text-xs text-gray-500 mb-2 font-medium">IDENTIFICADOR SYNC-POINT ÚNICO (Para Auditoría):</p>
            <code id="user-id-display" class="bg-[#070D13] text-text-highlight p-2 rounded text-sm break-all font-mono border border-accent-cobalt/30"></code>
        </div>

        <!-- FORMULARIO BLINDAJE T-01 -->
        <div id="blindaje-form-area" class="mt-8">
            <h2 class="text-2xl text-accent-cobalt font-bold mb-5 border-b border-text-highlight/30 pb-3">REGISTRO T-01: Certificación de Transparencia del Origen</h2>

            <div class="mb-6">
                <label for="crypto-address" class="block text-lg font-medium mb-2 text-text-standard">
                    Dirección Pública (Validación de Vínculo Certificado)
                </label>
                <input type="text" id="crypto-address" placeholder="Ingrese aquí la dirección de billetera/entidad certificada"
                        class="w-full px-4 py-3 bg-[#070D13] border border-accent-cobalt/60 rounded-lg focus:ring-accent-cobalt focus:border-accent-cobalt text-text-standard placeholder-gray-600 transition-colors duration-200 text-base">
            </div>

            <button id="activate-button" onclick="handleBlindajeT01()"
                    class="w-full font-extrabold text-lg py-3 rounded-lg uppercase tracking-wider disabled:opacity-30 disabled:cursor-not-allowed"
                    disabled>
                ACTIVAR BLINDAJE T-01 Y CERTIFICAR CUMPLIMIENTO
            </button>
        </div>

        <!-- AREA DE MENSAJES Y RESULTADOS -->
        <div id="message-container" class="mt-8 p-4 rounded-lg hidden">
            <p id="message-text" class="text-base"></p>
        </div>
    </div>

    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================================
        // !!! ATENCIÓN: CONFIGURACIÓN FUERA DEL ENTORNO DE SIMULACIÓN (REEMPLAZAR)
        // =========================================================================================
        
        // ** COMANDE: Debe reemplazar el contenido de la constante 'FIREBASE_CONFIG' 
        // con las credenciales reales de su proyecto. **
        const FIREBASE_CONFIG = {
            apiKey: "PEGA_AQUI_TU_API_KEY", 
            authDomain: "PEGA_AQUI_TU_AUTH_DOMAIN",
            projectId: "PEGA_AQUI_TU_PROJECT_ID", // Usado como App ID para la ruta de Firestore
            storageBucket: "PEGA_AQUI_TU_STORAGE_BUCKET",
            messagingSenderId: "PEGA_AQUI_TU_MESSAGING_SENDER_ID",
            appId: "PEGA_AQUI_TU_APP_ID"
        };

        const APP_ID = FIREBASE_CONFIG.projectId || 'default-app-id'; 

        // Referencias del DOM 
        const authStatusText = document.getElementById('auth-status-text');
        const systemStatusBox = document.getElementById('system-status');
        const activateButton = document.getElementById('activate-button');
        const cryptoAddressInput = document.getElementById('crypto-address');
        const userIdDisplay = document.getElementById('user-id-display');
        const userInfoDiv = document.getElementById('user-info');
        const messageContainer = document.getElementById('message-container');
        const messageText = document.getElementById('message-text');

        let db;
        let auth;
        let userId = 'N/A';
        let isAuthReady = false;

        // Función para mostrar mensajes de estado/resultado (Coherente con la nueva paleta)
        function displayMessage(text, type = 'status-success') {
            messageContainer.classList.remove('hidden', 'status-ready', 'status-loading', 'status-error', 'status-success');
            messageContainer.className = `mt-8 p-4 rounded-lg status-box ${type}`;
            messageText.textContent = text;
        }

        // --- Configuración e Inicialización de Firebase (Adaptada para GITHUB) ---
        try {
            if (FIREBASE_CONFIG.apiKey.includes('PEGA_AQUI_TU_API_KEY')) {
                throw new Error("ERROR [E-CFG]: Configuración de credenciales incompleta. Verifique 'FIREBASE_CONFIG'.");
            }
            
            setLogLevel('debug');
            const app = initializeApp(FIREBASE_CONFIG);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    userInfoDiv.classList.remove('hidden');

                    systemStatusBox.className = 'status-box status-ready';
                    authStatusText.textContent = 'Enlace Fiduciario: ONLINE. SYNC-POINT Autenticado. Protocolo Operativo.';
                    activateButton.disabled = false;
                    isAuthReady = true;
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Error de autenticación:", error);
                        systemStatusBox.className = 'status-box status-error';
                        authStatusText.textContent = 'ERROR [A-01]: Fallo crítico en la autenticación. Sistema Detenido.';
                        activateButton.disabled = true;
                        isAuthReady = false;
                        displayMessage(`ERROR CRÍTICO [A-01]: Fallo al establecer vínculo seguro. ${error.message}`, 'status-error');
                    }
                }
            });

        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            systemStatusBox.className = 'status-box status-error';
            authStatusText.textContent = `ERROR [I-00]: Fallo de Inicialización de Infraestructura. ${error.message}`;
            activateButton.disabled = true;
            isAuthReady = false;
            displayMessage(`ERROR [I-00]: Fallo de Inicialización. Revise la consola para detalles.`, 'status-error');
        }


        // --- Función del Blindaje T-01 (Lógica sin cambios) ---
        window.handleBlindajeT01 = async () => {
            if (!isAuthReady) {
                displayMessage("Error: Núcleo no operativo. Esperando sincronización.", 'status-error');
                return;
            }

            const address = cryptoAddressInput.value.trim();

            if (address.length < 20) {
                displayMessage("ADVERTENCIA [E-02]: La Dirección Pública debe ser válida para la certificación (mínimo 20 caracteres).", 'status-error');
                return;
            }

            activateButton.disabled = true;
            activateButton.textContent = 'EJECUTANDO PROTOCOLO (VALIDACIÓN DE CUMPLIMIENTO)...';
            displayMessage("Blindaje T-01 en curso. Registrando Petición en el Ledger de Cumplimiento...", 'status-loading');

            try {
                // Ruta de la colección pública para el Blindaje T-01
                const collectionPath = `artifacts/${APP_ID}/public/data/blindaje_t01_requests`;
                const blindajeCollection = collection(db, collectionPath);

                const blindajeData = {
                    syncPointId: userId,
                    blindajeAddress: address,
                    timestamp: serverTimestamp(),
                    protocolVersion: 'V13.0.5 (Confianza Inmutable)',
                    status: 'T-01_CERTIFICACION_EN_PROGRESO',
                    memo: 'Registro de solicitud de certificación de origen por el Módulo de Integridad.'
                };

                const docRef = await addDoc(blindajeCollection, blindajeData);

                // Éxito:
                displayMessage(
                    `CERTIFICACIÓN T-01 CONCLUIDA. ` +
                    `ID ÚNICO DE REGISTRO: ${docRef.id}. ESTADO: VÍNCULO SÓLIDO Y VERIFICADO.`,
                    'status-success'
                );
                console.log(`Blindaje T-01 registrado. Document ID: ${docRef.id}`);
                cryptoAddressInput.disabled = true;

            } catch (e) {
                // Fallo:
                console.error("Error al registrar Blindaje T-01:", e);
                displayMessage(`FALLO CRÍTICO [T-01]: Error en la comunicación con el Ledger. ${e.message}. Revise su conexión y configuración.`, 'status-error');
            } finally {
                // El campo de dirección solo se desbloquea si hay un error
                if (cryptoAddressInput.disabled && messageContainer.className.includes('status-error')) {
                    cryptoAddressInput.disabled = false;
                }
                activateButton.disabled = false;
                activateButton.textContent = 'ACTIVAR BLINDAJE T-01 Y CERTIFICAR CUMPLIMIENTO';
            }
        };

        window.handleBlindajeT01 = handleBlindajeT01;
    </script>
</body>
</html>







