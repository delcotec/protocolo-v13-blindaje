<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo V13 - Confianza Inmutable T-01 (AME)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // [SELLO DEL CREADOR] Configuraci√≥n de Dise√±o Inmutable (Sin Cambios Requeridos)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background-void': '#070D13',
                        'panel-deep': '#121921',
                        'accent-cobalt': '#005691',
                        'text-highlight': '#C0D6E4',
                        'text-standard': '#E0E6EB',
                        'alert-warning': '#C27B2B',
                        'alert-error-bg': 'rgba(194, 123, 43, 0.1)',
                        'urgency-red': '#E74C3C',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-void);
            color: var(--text-standard);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
        }
        .terminal-container {
            width: 100%;
            max-width: 600px;
            background-color: var(--panel-deep);
            border: 1px solid var(--accent-cobalt);
            border-radius: 8px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.8);
        }
        .status-box { border-left: 4px solid; padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 4px; font-weight: 600; }
        .status-ready { border-color: #005691; background-color: rgba(0, 86, 145, 0.1); color: #C0D6E4; }
        .status-loading { border-color: #6A798A; background-color: rgba(106, 121, 138, 0.1); color: #E0E6EB; }
        .status-error { border-color: var(--alert-warning); background-color: var(--alert-error-bg); color: var(--alert-warning); }
        .status-success { border-color: #1E8449; background-color: rgba(30, 132, 73, 0.1); color: #90EE90; }

        #activate-button {
            background-color: #005691;
            color: white;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 8px rgba(0, 86, 145, 0.5);
            border: 1px solid #00406F;
        }
        #activate-button:hover:not(:disabled) {
            background-color: #0070B8;
            box-shadow: 0 4px 12px rgba(0, 86, 145, 0.7);
            transform: translateY(-1px);
        }
    </style>
</head>
<body onload="iniciar_contador_ame()">

    <div id="app" class="terminal-container p-8 md:p-10">
        <h1 class="text-4xl font-extrabold mb-4 text-text-highlight text-center uppercase tracking-widest border-b border-accent-cobalt/50 pb-3">
            PROTOCOLO V13: CONFIANZA INMUTABLE
        </h1>
        <p class="text-md font-light text-center mb-8 text-gray-400">
            M√≥dulo de Cumplimiento Normativo y Verificaci√≥n de V√≠nculo (T-01)
        </p>

        <div id="urgency-bar" class="status-box" style="border-color: var(--urgency-red); background-color: rgba(231, 76, 60, 0.1);">
            <p class="font-extrabold text-xl text-center" style="color: var(--urgency-red);">
                OFERTA REL√ÅMPAGO FANTASMA CIERRA EN: <span id="contador-ame" class="font-black text-2xl">--:--:--</span>
            </p>
        </div>

        <div id="system-status" class="status-box status-error">
            <p class="font-extrabold text-xl text-text-standard">Estado del Enlace Fiduciario:</p>
            <p id="auth-status-text" class="text-sm">ERROR [I-00]: Fallo de Inicializaci√≥n. PROTOCOLO ZRD (Riesgo Cero) ACTIVO. Venta en Modo Local.</p>
        </div>

        <div id="user-info" class="mb-6 hidden">
            <p class="text-xs text-gray-500 mb-2 font-medium">IDENTIFICADOR SYNC-POINT √öNICO (Para Auditor√≠a):</p>
            <code id="user-id-display" class="bg-[#070D13] text-text-highlight p-2 rounded text-sm break-all font-mono border border-accent-cobalt/30">N/A</code>
        </div>

        <div id="blindaje-form-area" class="mt-8">
            <h2 class="text-2xl text-accent-cobalt font-bold mb-5 border-b border-text-highlight/30 pb-3">REGISTRO T-01: Certificaci√≥n de Transparencia del Origen</h2>

            <div class="mb-6">
                <label for="crypto-address" class="block text-lg font-medium mb-2 text-text-standard">
                    Direcci√≥n P√∫blica (V√≠nculo Certificado - **SOLO ETHEREUM**)
                </label>
                <input type="text" id="crypto-address" placeholder="Ej: 0x22Bf...D5c3"
                        class="w-full px-4 py-3 bg-[#070D13] border border-accent-cobalt/60 rounded-lg focus:ring-accent-cobalt focus:border-accent-cobalt text-text-standard placeholder-gray-600 transition-colors duration-200 text-base">
            </div>

            <button id="activate-button" onclick="handleBlindajeT01()"
                    class="w-full font-extrabold text-lg py-3 rounded-lg uppercase tracking-wider disabled:opacity-30"
                    >
                ACTIVAR BLINDAJE T-01 Y CERTIFICAR CUMPLIMIENTO
            </button>
        </div>

        <div id="message-container" class="mt-8 p-4 rounded-lg hidden">
            <p id="message-text" class="text-base"></p>
        </div>
    </div>

    <script type="module">
        // =========================================================================================
        // ‚öîÔ∏è N√öCLEO INMUTABLE V13.1.1 - FUSI√ìN HEXA-QU√ÅNTICA (SECUENCIA DE COBALTO)
        // =========================================================================================
        
        // Simulaci√≥n de los imports para evitar errores en entornos sin servidor (Modo ZRD)
        const initializeApp = (config) => ({ name: "ZRD_APP" });
        const getAuth = (app) => ({});
        const getFirestore = (app) => ({});
        const signInAnonymously = async (auth) => ({ user: { uid: 'ZRD_USER_' + Date.now() } });
        const onAuthStateChanged = (auth, callback) => {
            const simulatedUser = { uid: 'ZRD_USER_' + Date.now() };
            setTimeout(() => callback(simulatedUser), 100);
        };
        const addDoc = async (collection, data) => ({ id: 'ZRD_DOC_' + Date.now() });
        const serverTimestamp = () => new Date().toISOString(); 
        const setLogLevel = () => {}; 
        const collection = (db, path) => ({});


        // Constantes del NODO ALTO (Derivadas 1 y 3)
        // ** URL DE √âXITO FINAL (Solo se usa como fallback o referencia, la principal es la de Stripe) **
        const URL_CHECKOUT_FALLBACK = "https://jorgeluis.vercel.app/gracias"; 
        
        // ** WEBHOOK REAL: APUNTA A SU PUENTE LOCAL (puente_full.py) en el puerto 8001 **
        const URL_WEBHOOK_ESCALADO = "http://127.0.0.1:8001/ejecutar"; // ENLACE INELUDIBLE
        
        const CIERRE_OFERTA_AME = '2025-11-01T14:30:00Z'; 

        // Referencias del DOM y variables de estado
        const authStatusText = document.getElementById('auth-status-text');
        const systemStatusBox = document.getElementById('system-status');
        const activateButton = document.getElementById('activate-button');
        const cryptoAddressInput = document.getElementById('crypto-address');
        const userIdDisplay = document.getElementById('user-id-display');
        const userInfoDiv = document.getElementById('user-info');
        const messageContainer = document.getElementById('message-container');
        const messageText = document.getElementById('message-text');

        let userId = 'N/A';

        // Funci√≥n de utilidad
        function displayMessage(text, type = 'status-success') {
            messageContainer.classList.remove('hidden', 'status-ready', 'status-loading', 'status-error', 'status-success');
            messageContainer.className = `mt-8 p-4 rounded-lg status-box ${type}`;
            messageText.textContent = text;
        }

        // ‚öîÔ∏è BLINDAJE ESTRAT√âGICO: Validaci√≥n de Formato ETH (Derivada 2)
        function es_direccion_eth(direccion) {
            const eth_regex = /^(0x)?[0-9a-fA-F]{40}$/;
            return eth_regex.test(direccion);
        }

        // --- Inicializaci√≥n Simplificada (Protocolo ZRD) ---
        (function initZRD() {
            // Se fuerza el modo ZRD (Riesgo Cero)
            const simulatedUser = { uid: 'ZRD_USER_' + Date.now() };
            userId = simulatedUser.uid;
            userIdDisplay.textContent = userId;
            userInfoDiv.classList.remove('hidden');
            systemStatusBox.className = 'status-box status-error'; 
            authStatusText.textContent = `ERROR [I-00]: Fallo de Inicializaci√≥n. PROTOCOLO ZRD (Riesgo Cero) ACTIVO. Venta en Modo Local.`;
            activateButton.disabled = false;
        })();


        // =========================================================================================
        // üöÄ FUNCI√ìN CENTRAL V13.1.1: FUSI√ìN HEXA-QU√ÅNTICA (SECUENCIA DE COBALTO)
        // =========================================================================================
        window.handleBlindajeT01 = async () => {
            const address = cryptoAddressInput.value.trim();

            if (!es_direccion_eth(address)) {
                displayMessage("ADVERTENCIA [E-02]: Direcci√≥n no Certificada. **SOLO** se acepta formato Ethereum para el Blindaje T-01 (0x...).", 'status-error');
                return;
            }

            activateButton.disabled = true;
            activateButton.textContent = 'EJECUTANDO PROTOCOLO (SECUENCIA DE COBALTO: PRIORIDAD PAGO)...';
            displayMessage("Blindaje T-01 en curso. Iniciando Creaci√≥n de Sesi√≥n de Pago Cr√≠tica...", 'status-loading');

            const leadMetadata = {
                syncPointId: userId,
                blindajeAddress: address
            };
            
            const mensajeVenta = 
                `üî• [VENTA CR√çTICA $1,777 USD - ALFA V13.1.1] üî•\n` +
                `NUEVO LEAD CAPTURADO Y BLINDADO.\n` +
                `ID V√çNCULO: ${userId}\n` +
                `DIRECCI√ìN ETH: ${address}\n` +
                `FECHA: ${new Date().toISOString()}`;

            const stripePaymentPayload = {
                provider: "stripe", 
                action: "create_checkout_session", 
                payload: {
                    amount: 177700, // $1777 USD en centavos
                    currency: 'usd',
                    product_name: 'Protocolo V13: Confianza Inmutable',
                    metadata: leadMetadata,
                }
            };
            
            // --- 1. ACCI√ìN CR√çTICA SINCR√ìNICA: CREACI√ìN DE PAGO STRIPE ---
            let stripe_response_data;
            try {
                const response = await fetch(URL_WEBHOOK_ESCALADO, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(stripePaymentPayload)
                });

                if (!response.ok) {
                    throw new Error(`Fallo HTTP: ${response.status}. Revise el log del Puente PY.`);
                }
                
                stripe_response_data = await response.json();
                
                if (stripe_response_data.status !== "success" || !stripe_response_data.checkout_url) {
                    throw new Error(stripe_response_data.message || "Fallo Stripe: URL de Checkout no recibida. Clave STRIPE_API_KEY incorrecta.");
                }
                
                const checkoutUrl = stripe_response_data.checkout_url;
                
                // --- 2. ACCIONES AS√çNCRONAS: BLINDAJE DE NOTIFICACIONES ---
                displayMessage("¬°√âXITO CR√çTICO! Sesi√≥n de Pago Creada. Blindando Notificaciones...", 'status-success');
                activateButton.textContent = 'REDIRECCIONANDO A PAGO INELUDIBLE...';
                
                const dataLog = {
                    type: "LEAD_CAPTURED",
                    sync_id: userId,
                    crypto_address: address,
                    value: 1777,
                    timestamp: new Date().toISOString()
                };
                
                const secondaryPayloads = [
                    // Notificaciones Primarias
                    { provider: "telegram", action: "send_message", payload: { text: mensajeVenta, force: true } },
                    { provider: "whatsapp", action: "send_message", payload: { text: mensajeVenta, to: "auto" } }, 
                    // Log de Datos Brutos
                    { provider: "zapier", action: "log_data", payload: dataLog },
                    // Notificaciones de Contingencia (Se ejecutan pero no afectan el flujo principal)
                    { provider: "slack", action: "send_message", payload: { text: "SLACK ALERT: " + mensajeVenta, force: false } },
                    { provider: "discord", action: "send_message", payload: { text: "DISCORD ALERT: " + mensajeVenta, force: false } },
                ];
                
                // Disparar notificaciones en segundo plano (no esperamos respuesta)
                secondaryPayloads.forEach(payload => {
                    fetch(URL_WEBHOOK_ESCALADO, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }).catch(error => console.error(`Error as√≠ncrono en ${payload.provider}:`, error));
                });
                
                // --- 3. REDIRECCI√ìN INELUDIBLE ---
                // Damos un breve momento para que el usuario lea el √©xito y las notificaciones se inicien.
                setTimeout(() => {
                    window.location.href = checkoutUrl; // LA EJECUCI√ìN ES AQU√ç
                }, 700); 

            } catch (error) {
                // --- MANEJO DE FRICCI√ìN FALLIDA ---
                const finalMsg = `FALLO CR√çTICO EN MONETIZACI√ìN: ${error.message}`;
                displayMessage(finalMsg, 'status-error');
                
                cryptoAddressInput.disabled = false;
                activateButton.disabled = false;
                activateButton.textContent = 'ERROR EN PAGO - REINTENTAR BLINDAJE';
                console.error("Fallo Fatal en Stripe Checkout:", error);

                // Como FALL√ì el pago, redirigimos al fallback para no perder el lead completamente.
                setTimeout(() => {
                    window.location.href = URL_CHECKOUT_FALLBACK;
                }, 1500); 
            }
        };


        // ‚è≥ NODO ALTO DE URGENCIA FANTASMA (Mantenido)
        window.iniciar_contador_ame = () => {
            const fecha_cierre = new Date(CIERRE_OFERTA_AME).getTime();
            const contador_dom = document.getElementById("contador-ame");
            const button_dom = document.getElementById("activate-button");

            const x = setInterval(function() {
                const ahora = new Date().getTime();
                const distancia = fecha_cierre - ahora;

                if (distancia < 0) {
                    clearInterval(x);
                    contador_dom.innerHTML = "OFERTA CERRADA - MULTIPLICADOR INACTIVO";
                    button_dom.disabled = true;
                    return;
                }

                const h = Math.floor((distancia % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((distancia % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((distancia % (1000 * 60)) / 1000);

                contador_dom.innerHTML = `${h < 10 ? "0" + h : h}:${m < 10 ? "0" + m : m}:${s < 10 ? "0" + s : s}`;
            }, 1000);
        }

        window.handleBlindajeT01 = handleBlindajeT01;
    </script>
</body>
</html>











