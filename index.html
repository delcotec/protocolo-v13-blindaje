<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo V13 | Módulo de Aterrizaje DCA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; 
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        #terminal-card {
            background: #1f2a37;
            border: 1px solid #30363d;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            border-radius: 16px;
            padding: 30px;
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .terminal-header {
            color: #718096;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .header-dots > div {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }
        .dot-red { background-color: #ff605c; }
        .dot-yellow { background-color: #ffbd44; }
        .dot-green { background-color: #00ca4e; }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            background-color: #2d3748;
            border-radius: 8px;
        }

        .input-group label {
            color: #a0aec0;
            font-size: 0.9rem;
            margin-bottom: 4px;
            display: block;
        }
        
        .input-group input {
            background-color: #1a202c;
            border: 1px solid #4a5568;
            color: #ffffff;
            padding: 10px;
            border-radius: 6px;
            width: 100%;
            transition: border-color 0.2s;
        }
        
        .input-group input:focus {
            border-color: #8be9fd;
            outline: none;
        }

        #log-area-container {
            display: flex;
            gap: 20px;
            flex-grow: 1;
        }

        #log-area {
            height: 400px;
            overflow-y: auto;
            background-color: #010409;
            border-radius: 8px;
            padding: 15px;
            font-size: 0.875rem;
            line-height: 1.4;
            color: #b3b3b3;
            flex: 1;
        }

        #summary-area {
            height: 400px;
            background-color: #2d3748;
            border: 1px solid #4a5568;
            border-radius: 8px;
            padding: 15px;
            font-size: 0.9rem;
            line-height: 1.5;
            flex: 1;
        }

        .log-line {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .log-error { color: #ff5555; font-weight: 700; }
        .log-success { color: #50fa7b; font-weight: 700; }
        .log-instruction { color: #8be9fd; }
        .log-state { color: #ffb86c; }
        .log-pending { color: #f1fa8c; }
        .log-dca { color: #ff79c6; } /* Fucsia para transacciones DCA */
        .log-summary-title { color: #8be9fd; font-weight: 700; border-bottom: 1px solid #4a5568; padding-bottom: 5px; margin-bottom: 10px; }


        .btn-distribute {
            background-image: linear-gradient(to right, #00ca4e, #008032);
            box-shadow: 0 4px #005020;
            transition: all 0.1s;
        }

        .btn-distribute:active {
            box-shadow: 0 2px #005020;
            transform: translateY(2px);
        }

        /* Modal (sin cambios, para manejo de errores) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #2d3748;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid #4a5568;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 15px;
        }

        .modal-message {
            color: #cbd5e0;
            margin-bottom: 25px;
        }

        .modal-button {
            background-color: #48bb78;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 700;
            transition: background-color 0.2s;
        }

        .modal-button:hover {
            background-color: #38a169;
        }
    </style>
</head>
<body>

    <div id="terminal-card">
        <div class="terminal-header">
            <div class="header-dots">
                <div class="dot-red"></div>
                <div class="dot-yellow"></div>
                <div class="dot-green"></div>
            </div>
            <span>SISTEMA DCA V13 - <span id="protocol-status">BUSCANDO BLINDAJE...</span></span>
        </div>

        <!-- Panel de Control y Parámetros -->
        <div class="control-panel">
            <h2 class="text-xl font-bold text-white mb-2 border-b border-gray-600 pb-2">Parámetros de Aterrizaje (DCA)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="input-group">
                    <label for="total-capital">Capital Total a Distribuir (Simulación)</label>
                    <input type="number" id="total-capital" value="500000" min="1" placeholder="Ej: 500000" disabled>
                </div>
                <div class="input-group">
                    <label for="num-wallets">Número de Lotes/Billeteras de Destino</label>
                    <input type="number" id="num-wallets" value="10" min="2" max="100" placeholder="Ej: 10">
                </div>
            </div>
            <button id="distribute-button" class="btn-distribute w-full py-3 rounded-xl text-white font-bold text-lg" disabled>
                INICIAR DISTRIBUCIÓN DCA (ATERRIZAJE)
            </button>
        </div>

        <!-- Área de Log y Resumen -->
        <div id="log-area-container">
            <div id="log-area" class="log-area">
                <!-- Log de Transacciones -->
            </div>
            <div id="summary-area" class="summary-area">
                <div class="log-summary-title">Resumen de Distribución</div>
                <p id="summary-status">Esperando inicio de distribución...</p>
                <!-- Aquí se llenará el resumen -->
            </div>
        </div>

    </div>

    <!-- Modal genérico para mensajes (reemplaza alert) -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <div id="message-modal-title" class="modal-title">Mensaje del Sistema</div>
            <div id="message-modal-message" class="modal-message"></div>
            <button id="message-modal-button" class="modal-button">Aceptar</button>
        </div>


    <script>
        // Variables globales del DOM
        let logArea;
        let protocolStatusElement;
        let distributeButton;
        let summaryArea;
        let summaryStatus;

        // Variables de Estado
        let systemState = 'INACTIVO';
        const BASE_WALLET_ADDRESS = "T1P2X3Y4Z5A6B7C8D9E0F1G2H3I4J5K6L7M8N9O0P1Q2R3S4";

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar elementos del DOM
            logArea = document.getElementById('log-area');
            protocolStatusElement = document.getElementById('protocol-status');
            distributeButton = document.getElementById('distribute-button');
            summaryArea = document.getElementById('summary-area');
            summaryStatus = document.getElementById('summary-status');

            // Event Listeners
            distributeButton.addEventListener('click', handleDistribution);
            document.getElementById('message-modal-button').addEventListener('click', hideMessageModal);

            // Iniciar el sistema y buscar el blindaje
            logMessage('INICIANDO MÓDULO DCA V13...', 'success');
            setTimeout(initializeSystem, 1500);
        });

        // --- Funciones de Utilidad de Log y Modal ---

        function logMessage(message, type = '') {
            const line = document.createElement('div');
            line.className = `log-line ${type ? 'log-' + type : ''}`;
            line.textContent = `> ${message}`;
            logArea.appendChild(line);
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function showMessageModal(title, message) {
            document.getElementById('message-modal-title').textContent = title;
            document.getElementById('message-modal-message').textContent = message;
            document.getElementById('message-modal').style.display = 'flex';
        }

        function hideMessageModal() {
            document.getElementById('message-modal').style.display = 'none';
        }
        
        function updateSummary(totalDistributed, numLotes, montoPorLote, tiempoEstimado) {
            summaryArea.innerHTML = `
                <div class="log-summary-title">Resumen de Distribución</div>
                <p class="text-white mb-2">Estado: <span class="log-success font-bold">${systemState}</span></p>
                <hr class="border-gray-600 my-2">
                <p>Capital Total: <span class="font-bold text-lg">${formatCurrency(totalDistributed)}</span></p>
                <p>Lotes de Distribución: <span class="font-bold">${numLotes}</span></p>
                <p>Monto por Lote: <span class="font-bold log-dca">${formatCurrency(montoPorLote)}</span></p>
                <p>Transacciones/Segundo: <span class="font-bold">2.5 tps (Sim.)</span></p>
                <p>Tiempo Estimado: <span class="font-bold log-instruction">${tiempoEstimado}</span></p>
                <hr class="border-gray-600 my-2">
                <p>Billetera Base: <span class="text-sm text-gray-400 break-all">${BASE_WALLET_ADDRESS}</span></p>
            `;
        }
        
        function formatCurrency(amount) {
            // Simulación de formato de moneda con USD
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount);
        }

        // --- Lógica del Sistema ---

        function initializeSystem() {
            logMessage('CONECTANDO al estado de "Blindaje Activo"...', 'pending');
            
            // Simular que el blindaje está listo
            setTimeout(() => {
                systemState = 'BLINDAJE_ACTIVO';
                protocolStatusElement.textContent = 'BLINDAJE ACTIVO - LISTO DCA';
                distributeButton.disabled = false;
                distributeButton.textContent = 'INICIAR DISTRIBUCIÓN DCA (ATERRIZAJE)';
                logMessage('CONEXIÓN ESTABLECIDA. Capital blindado listo para Aterrizaje.', 'success');
                logMessage('Instrucción: Defina los parámetros y pulse Iniciar Distribución.', 'instruction');
                
                // Cargar resumen inicial
                const total = parseFloat(document.getElementById('total-capital').value);
                const numWallets = parseFloat(document.getElementById('num-wallets').value);
                updateSummary(total, numWallets, total / numWallets, 'Aún no calculado');

            }, 2000);
        }

        /**
         * Genera una dirección de billetera simulada.
         * @param {number} index - Índice del lote para hacerlo único.
         */
        function generateDestinationAddress(index) {
            // Genera una dirección pseudo-única basada en la base y el índice
            const base = BASE_WALLET_ADDRESS.substring(0, BASE_WALLET_ADDRESS.length - 2);
            const indexStr = index.toString().padStart(2, '0');
            return base + indexStr;
        }

        /**
         * Simula el proceso de Distribución Centralizada de Activos (DCA).
         */
        async function handleDistribution() {
            if (systemState !== 'BLINDAJE_ACTIVO') {
                showMessageModal('ERROR', 'El Blindaje no está activo o la conexión se perdió. Intente recargar.');
                return;
            }

            const totalCapitalInput = document.getElementById('total-capital');
            const numWalletsInput = document.getElementById('num-wallets');

            const totalCapital = parseFloat(totalCapitalInput.value);
            const numWallets = parseInt(numWalletsInput.value, 10);

            if (isNaN(totalCapital) || totalCapital <= 0 || isNaN(numWallets) || numWallets < 2) {
                showMessageModal('ERROR DE PARÁMETRO', 'Asegúrese de que el capital sea positivo y el número de lotes sea al menos 2.');
                return;
            }

            // Inhabilitar controles
            distributeButton.disabled = true;
            totalCapitalInput.disabled = true;
            numWalletsInput.disabled = true;
            systemState = 'DCA_EN_PROCESO';
            protocolStatusElement.textContent = 'DCA EN PROCESO';
            distributeButton.textContent = 'DISTRIBUCIÓN EN CURSO...';

            logMessage('INICIANDO PROCESO DCA V13...', 'success');
            logMessage(`Dividiendo ${formatCurrency(totalCapital)} en ${numWallets} lotes.`, 'instruction');

            const amountPerWallet = totalCapital / numWallets;
            let totalDistributed = 0;
            const startTime = Date.now();

            updateSummary(totalCapital, numWallets, amountPerWallet, 'Calculando...');


            // Iteración de distribución
            for (let i = 1; i <= numWallets; i++) {
                const destinationAddress = generateDestinationAddress(i);
                
                // Simular un pequeño retraso (para el log visual)
                await new Promise(resolve => setTimeout(resolve, 300));

                totalDistributed += amountPerWallet;

                logMessage(
                    `LOTE ${i.toString().padStart(2, '0')}/${numWallets}: Transfiriendo ${formatCurrency(amountPerWallet)} a ${destinationAddress}`, 
                    'dca'
                );

                const elapsedSeconds = (Date.now() - startTime) / 1000;
                const remainingTime = (elapsedSeconds / i) * (numWallets - i);
                const timeStr = remainingTime > 60 ? 
                                `${(remainingTime / 60).toFixed(1)} min` : 
                                `${remainingTime.toFixed(1)} seg`;

                updateSummary(totalCapital, numWallets, amountPerWallet, timeStr + ' restante');
            }

            // Finalización
            systemState = 'DCA_FINALIZADO';
            protocolStatusElement.textContent = 'DCA FINALIZADO';
            distributeButton.textContent = 'DCA FINALIZADO - CAPITAL ATERRIZADO';
            distributeButton.classList.remove('btn-distribute');
            distributeButton.classList.add('bg-gray-600');

            const finalTime = ((Date.now() - startTime) / 1000).toFixed(1) + ' segundos';
            updateSummary(totalCapital, numWallets, amountPerWallet, finalTime + ' (Completado)');
            
            logMessage('*** DISTRIBUCIÓN DCA COMPLETA ***', 'success');
            logMessage(`Capital total aterrizado en ${numWallets} lotes en ${finalTime}.`, 'success');
            logMessage('Sistema de Aterrizaje V13 en MODO INACTIVO.', 'instruction');
        }
    </script>
</body>
</html>



