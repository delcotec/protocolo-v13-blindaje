<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo V13 | Solicitud de Blindaje</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fondo oscuro tipo consola */
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        #terminal-card {
            background: #1f2a37; /* Color de tarjeta más oscuro */
            border: 1px solid #30363d;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 700px;
        }

        #log-area {
            height: 300px;
            overflow-y: auto;
            background-color: #010409; /* Fondo de log muy oscuro */
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.875rem;
            line-height: 1.4;
            color: #b3b3b3; /* Color de texto suave */
        }

        .log-line {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .log-error {
            color: #ff5555; /* Rojo para errores */
            font-weight: 700;
        }

        .log-success {
            color: #50fa7b; /* Verde para éxito/activo */
            font-weight: 700;
        }
        
        .log-instruction {
            color: #8be9fd; /* Azul claro para instrucciones */
        }

        .log-state {
            color: #ffb86c; /* Naranja para estados */
        }

        .log-pending {
            color: #f1fa8c; /* Amarillo para pendiente */
        }

        .terminal-header {
            color: #718096;
            margin-bottom: 15px;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
        }

        .header-dots > div {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }
        .dot-red { background-color: #ff605c; }
        .dot-yellow { background-color: #ffbd44; }
        .dot-green { background-color: #00ca4e; }

        .btn-protocol {
            background-image: linear-gradient(to right, #ff8a00, #e25e00);
            box-shadow: 0 4px #a04200;
            transition: all 0.1s;
        }

        .btn-protocol:active {
            box-shadow: 0 2px #a04200;
            transform: translateY(2px);
        }

        /* Estilos del modal/pop-up personalizado */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #2d3748;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid #4a5568;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 15px;
        }

        .modal-message {
            color: #cbd5e0;
            margin-bottom: 25px;
        }

        .modal-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 5px;
            color: #ffffff;
        }

        .modal-button {
            background-color: #48bb78;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 700;
            transition: background-color 0.2s;
        }

        .modal-button:hover {
            background-color: #38a169;
        }
    </style>
</head>
<body>

    <div id="terminal-card">
        <div class="terminal-header">
            <div class="header-dots">
                <div class="dot-red"></div>
                <div class="dot-yellow"></div>
                <div class="dot-green"></div>
            </div>
            <span>Protocolo V13.exe - <span id="protocol-status">NÚCLEO INACTIVO</span></span>
        </div>

        <div id="log-area" class="log-area">
            <!-- El log se inserta aquí con JavaScript -->
        </div>

        <button id="execute-button" class="btn-protocol w-full py-3 rounded-xl text-white font-bold text-lg hover:brightness-110">
            EJECUTAR PROTOCOLO BLINDAJE V13
        </button>
    </div>

    <!-- Modal para ingresar la dirección de retorno -->
    <div id="input-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Solicitud de Retorno</div>
            <div class="modal-message">Introduzca su Dirección de Retorno (Billetera) para completar el registro.</div>
            <input type="text" id="wallet-address-input" class="modal-input" placeholder="Dirección de Billetera Válida (Simulación)">
            <button id="modal-submit-button" class="modal-button">Aceptar</button>
        </div>
    </div>
    
    <!-- Modal genérico para mensajes (reemplaza alert) -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <div id="message-modal-title" class="modal-title">Mensaje del Sistema</div>
            <div id="message-modal-message" class="modal-message"></div>
            <button id="message-modal-button" class="modal-button">Aceptar</button>
        </div>
    </div>


    <script>
        // Variables globales
        let logArea;
        let protocolStatusElement;
        let executeButton;
        let inputModal;
        let walletAddressInput;
        let messageModal;
        let messageModalTitle;
        let messageModalMessage;

        // Estado del sistema V13
        let systemState = 'INACTIVO';
        let walletAddress = '';
        let transactionCount = 0; // Contador de reintentos en PENDIENTE_PAGO
        let depositAddress = '';
        
        // Simulación de comando PADRE para salir del bucle PENDIENTE_PAGO
        const PADRE_COMMAND = "PADRE: \"REANUDAR V13 SIN SIMULACION Y SALIR DE TODO LOOP\"";

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar elementos del DOM
            logArea = document.getElementById('log-area');
            protocolStatusElement = document.getElementById('protocol-status');
            executeButton = document.getElementById('execute-button');
            inputModal = document.getElementById('input-modal');
            walletAddressInput = document.getElementById('wallet-address-input');
            messageModal = document.getElementById('message-modal');
            messageModalTitle = document.getElementById('message-modal-title');
            messageModalMessage = document.getElementById('message-modal-message');

            // Event Listeners
            executeButton.addEventListener('click', handleExecuteProtocol);
            document.getElementById('modal-submit-button').addEventListener('click', handleWalletSubmit);
            document.getElementById('message-modal-button').addEventListener('click', hideMessageModal);

            // Iniciar el sistema
            logMessage('INICIANDO NÚCLEO V13...', 'success');
            setTimeout(() => {
                logMessage('NÚCLEO ACTIVO. Listo para ejecutar protocolo.', 'success');
                protocolStatusElement.textContent = 'NÚCLEO ACTIVO';
                executeButton.disabled = false;
            }, 1500);
        });

        // --- Funciones de Utilidad de Log y Modal ---

        /**
         * Muestra un mensaje en el área de log.
         * @param {string} message - El texto a loggear.
         * @param {string} type - El tipo de mensaje ('error', 'success', 'instruction', 'state', 'pending', o vacío).
         */
        function logMessage(message, type = '') {
            const line = document.createElement('div');
            line.className = 'log-line';
            line.textContent = `> ${message}`;
            
            if (type) {
                line.classList.add(`log-${type}`);
            }

            logArea.appendChild(line);
            // Hacer scroll al final
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        /**
         * Muestra el modal de mensaje genérico (reemplazo de alert).
         */
        function showMessageModal(title, message) {
            messageModalTitle.textContent = title;
            messageModalMessage.textContent = message;
            messageModal.style.display = 'flex';
        }

        /**
         * Oculta el modal de mensaje genérico.
         */
        function hideMessageModal() {
            messageModal.style.display = 'none';
        }

        // --- Lógica del Protocolo ---
        
        /**
         * Genera una dirección de depósito simulada.
         */
        function generateDepositAddress() {
            // Genera una cadena alfanumérica simulada (ej. THJ65N2uWc9XyY7E7u6H9K3P4H8R8G2T9V)
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 34; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return 'TH' + result.toUpperCase();
        }

        /**
         * Lógica principal al hacer clic en el botón de Ejecutar.
         */
        function handleExecuteProtocol() {
            executeButton.disabled = true;
            logMessage('EJECUTANDO PROTOCOLO BLINDAJE V13 (OFFLINE/DEMO)...');

            if (systemState === 'INACTIVO') {
                // Paso 1: Iniciar el registro y pedir la dirección de retorno
                setTimeout(() => {
                    logMessage('Simulando creación de nuevo registro (Modo Demo)...');
                    systemState = 'REGISTRANDO';
                    inputModal.style.display = 'flex'; // Mostrar modal de input
                    executeButton.disabled = false;
                }, 1000);

            } else if (systemState === 'PENDIENTE_PAGO') {
                transactionCount++; // Aumentar el contador de intentos
                logMessage(`REINTENTANDO BLINDAJE (Intento ${transactionCount + 1})...`, 'pending');

                // *** Lógica de SALIDA DEL LOOP (Comando PADRE) ***
                // El comando PADRE se activa en el tercer clic después de llegar a PENDIENTE_PAGO (transactionCount = 2)
                if (transactionCount === 2) { 
                    logMessage(`Comando recibido: ${PADRE_COMMAND}`, 'instruction');
                    logMessage('SALIDA DE LOOP FORZADA. Ignorando simulación de pago en Modo Demo.', 'success');
                    logMessage('Verificando pago... (Simulación Rápida)', 'success');
                    
                    setTimeout(() => {
                        logMessage('PAGO CONFIRMADO (Simulación Forzada)', 'success');
                        logMessage('ACTIVANDO BLINDAJE V13...', 'success');
                        systemState = 'BLINDAJE_ACTIVO';
                        protocolStatusElement.textContent = 'BLINDAJE_ACTIVO';
                        executeButton.textContent = 'BLINDAJE ACTIVO - FINALIZADO';
                        executeButton.classList.remove('btn-protocol');
                        executeButton.classList.add('bg-green-600', 'hover:bg-green-700', 'shadow-green-900/50');
                        logMessage(`Estado Final: ${systemState}`, 'success');
                        executeButton.disabled = true;
                    }, 1000);
                } else {
                    // Simular que el pago aún no llega (Intento 1 y 2)
                    setTimeout(() => {
                        logMessage('REGISTRO DE BLINDAJE CREADO exitosamente (Simulación).', 'success');
                        logMessage('Estado: PENDIENTE_PAGO', 'pending');
                        logMessage(`DIRECCIÓN DE DEPÓSITO GENERADA: ${depositAddress}`, 'state');
                        logMessage('Instrucción: Deposite el monto a esta dirección para activar el blindaje (Modo Demo).', 'instruction');
                        executeButton.disabled = false;
                    }, 1500);
                }

            } else if (systemState === 'BLINDAJE_ACTIVO') {
                 // El sistema ya está activo, no hace nada
                logMessage('El Blindaje V13 ya está activo. Operación finalizada.', 'success');
                executeButton.disabled = true;

            } else {
                // Estado inesperado (o REGISTRANDO)
                logMessage('ERROR: Sistema en estado de registro. Espere la entrada de la billetera.', 'error');
                executeButton.disabled = false;
            }
        }

        /**
         * Maneja el envío de la dirección de billetera desde el modal.
         */
        function handleWalletSubmit() {
            const address = walletAddressInput.value.trim();
            if (address.length < 20) {
                // Reemplazo de alert por modal
                showMessageModal('ERROR DE VALIDACIÓN', 'Por favor, introduzca una dirección de billetera válida (mínimo 20 caracteres para simulación).');
                return;
            }

            walletAddress = address;
            inputModal.style.display = 'none'; // Ocultar modal de input
            
            // ************ CORRECCIÓN CLAVE: Reiniciar el contador ************
            transactionCount = 0; 
            
            // Continuar con el proceso de registro
            logMessage(`DIRECCIÓN DE RETORNO REGISTRADA: ${walletAddress}`, 'state');
            
            // Simular creación del registro V13 y depósito
            depositAddress = generateDepositAddress();
            systemState = 'PENDIENTE_PAGO';

            logMessage('REGISTRO V13 CREADO EN MODO OFFLINE (Simulación).', 'success');
            logMessage(`Estado: ${systemState}`, 'pending');
            logMessage(`Dirección de Depósito: ${depositAddress}`, 'state');
            logMessage('Instrucción: Deposite el monto a esta dirección para activar el blindaje (Modo Demo).', 'instruction');
            
            // Re-habilitar el botón para el siguiente paso
            executeButton.disabled = false;
        }

    </script>
</body>
</html>



